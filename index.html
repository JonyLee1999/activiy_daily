<html lang="zh-CN"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>O2O平台四象限对比看板（无十字箭头）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Chart.js加载脚本 -->
  <script>
    // Chart.js加载状态
    window.chartJsLoaded = false;
    window.chartJsLoadPromise = null;
    
    // 检查Chart.js是否已加载
    function checkChartJS() {
      return typeof Chart !== 'undefined' && Chart.version;
    }
    
    // 尝试加载Chart.js的多个CDN源
    function loadChartJS() {
      if (window.chartJsLoadPromise) {
        return window.chartJsLoadPromise;
      }
      
      console.log('开始加载Chart.js');
      
      window.chartJsLoadPromise = new Promise((resolve, reject) => {
        // 尝试加载第一个CDN源
        tryLoadChartJS('https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js', resolve, reject);
      });
      
      return window.chartJsLoadPromise;
    }
    
    // 尝试从指定URL加载Chart.js
    function tryLoadChartJS(url, resolve, reject, retryCount = 0) {
      console.log(`尝试从 ${url} 加载Chart.js`);
      
      const script = document.createElement('script');
      script.src = url;
      
      script.onload = function() {
        if (checkChartJS()) {
          window.chartJsLoaded = true;
          console.log('Chart.js加载成功，版本:', Chart.version);
          resolve();
        } else {
          // 如果加载成功但Chart对象不可用，尝试下一个CDN
          tryNextCDN(resolve, reject, retryCount);
        }
      };
      
      script.onerror = function() {
        console.log(`从 ${url} 加载Chart.js失败`);
        // 加载失败，尝试下一个CDN
        tryNextCDN(resolve, reject, retryCount);
      };
      
      document.head.appendChild(script);
    }
    
    // 尝试下一个CDN
    function tryNextCDN(resolve, reject, retryCount) {
      const cdnUrls = [
        'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
        'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
        'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js'
      ];
      
      if (retryCount < cdnUrls.length) {
        tryLoadChartJS(cdnUrls[retryCount], resolve, reject, retryCount + 1);
      } else {
        const error = new Error('所有Chart.js加载源都失败');
        console.error(error);
        reject(error);
      }
    }
    
    // 等待Chart.js加载完成
    function waitForChartJS() {
      return new Promise((resolve, reject) => {
        if (checkChartJS()) {
          resolve();
          return;
        }
        
        // 尝试加载Chart.js
        loadChartJS().then(resolve).catch(reject);
      });
    }
    
    // 页面加载完成后自动加载Chart.js
    document.addEventListener('DOMContentLoaded', function() {
      loadChartJS().catch(error => {
        console.error('Chart.js加载失败:', error);
        updateStatus('Chart.js加载失败', '❌');
      });
    });
  </script>
  <script>
    // 状态更新函数
    function updateStatus(message, icon) {
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.innerHTML = `${icon} ${message}`;
      }
    }
  </script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'meituan': '#FFD161',
             'eleme': '#0086FF',
             'jd': '#01af00',
            'hvle': '#FFF8E6',  // 高量低效背景
            'hvle-text': '#D48806', // 高量低效文字
            'hq': '#E6F7F0',    // 优质双高背景
            'hq-text': '#007A4D', // 优质双高文字
            'ltl': '#FFEEEE',   // 长尾双低背景
            'ltl-text': '#C53030', // 长尾双低文字
            'hele': '#F7F0E9',  // 高效低量背景
            'hele-text': '#A05F2C', // 高效低量文字
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .platform-column {
        @apply flex-1 p-3 border-r last:border-r-0 border-gray-100;
      }
      .platform-header {
        @apply text-center font-bold py-1.5 rounded mb-2 text-white;
      }
      .metric-item {
        @apply py-1.5 border-b border-gray-100 flex justify-between items-center;
      }
      .quadrant-card {
        @apply rounded-2xl shadow-lg hover:shadow-xl overflow-hidden transition-all duration-300 border border-gray-100;
      }
      .clickable {
        @apply cursor-pointer hover:bg-gray-50 transition-colors;
      }
      .axis-line {
        @apply absolute bg-gray-400 z-10;
      }
      .axis-label {
        @apply absolute font-medium text-gray-600 z-20 whitespace-nowrap;
      }
      /* 刻度样式 */
      .axis-tick {
        @apply absolute bg-gray-400 z-10;
      }
      .x-tick {
        @apply h-2 w-0.5;
      }
      .y-tick {
        @apply w-2 h-0.5;
      }
      .tick-label {
        @apply absolute text-xs text-gray-500 z-20 whitespace-nowrap;
      }
      .axis-title {
        @apply font-semibold text-gray-700;
      }
      /* 券明细样式 */
      .coupon-detail-row {
        @apply border-b border-gray-100 py-3 last:border-0;
      }
      .coupon-detail-label {
        @apply text-xs text-gray-500 mt-1;
      }
      /* 平台Tab样式 - 增强效果 */
      .platform-tab {
        @apply text-gray-600 hover:text-gray-800 shadow-md hover:shadow-lg;
      }
      .platform-tab.active {
        @apply bg-white text-blue-600 shadow-lg border border-blue-200;
      }
      
      /* 添加额外的样式增强 */
      .metric-card {
        @apply bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 transform hover:-translate-y-1;
      }
      
      .progress-container {
        @apply relative drop-shadow-lg;
      }
      
      .chart-enhanced {
        @apply bg-gradient-to-br from-white to-gray-50 rounded-xl border border-gray-200 shadow-inner;
      }
      
      /* 数据显示增强 */
      .data-value {
        @apply text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent;
      }
      
      .trend-positive {
        @apply text-green-600 bg-green-50 px-2 py-1 rounded-md text-xs font-medium;
      }
      
      .trend-negative {
        @apply text-red-600 bg-red-50 px-2 py-1 rounded-md text-xs font-medium;
      }
    }
  </style>
</head>

<body class="bg-gray-50 p-4 md:p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">O2O平台业务对比看板</h1>
    <p class="text-gray-500 mb-4">四象限分析（ROI vs 活动GMV占比）</p>
    
    <!-- 日期范围筛选器 -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 mb-6 p-4">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <div class="flex items-center gap-2">
          <i class="fa fa-calendar text-blue-600"></i>
          <span class="text-sm font-medium text-gray-700">数据时间范围：</span>
        </div>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">开始日期：</label>
            <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">结束日期：</label>
            <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <button id="applyDateFilter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
            <i class="fa fa-filter"></i>
            应用筛选
          </button>
          <button id="resetDateFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
            <i class="fa fa-refresh"></i>
            重置
          </button>
        </div>
      </div>
      <div class="mt-3 text-xs text-gray-500">
        <span id="dateRangeDisplay">当前选择：</span>
      </div>
    </div>
    
    <!-- 图表状态指示器 -->
    <div id="chartStatus" class="mb-4 p-3 rounded-lg bg-yellow-100 border border-yellow-300">
      <div class="flex items-center">
        <div id="statusIcon" class="mr-2">⏳</div>
        <div id="statusText">正在加载图表...</div>
      </div>
    </div>

    <!-- 平台Tab导航 - 增强样式 -->
    <div class="flex space-x-2 mb-8 bg-gradient-to-r from-gray-100 to-gray-200 p-2 rounded-xl w-fit shadow-lg border border-gray-200">
      <button id="tab-all" class="platform-tab active px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 transform hover:scale-105" onclick="switchPlatform('all')">全平台</button>
      <button id="tab-meituan" class="platform-tab px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 transform hover:scale-105" onclick="switchPlatform('meituan')">美团</button>
      <button id="tab-eleme" class="platform-tab px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 transform hover:scale-105" onclick="switchPlatform('eleme')">饿了么</button>
      <button id="tab-jd" class="platform-tab px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-300 transform hover:scale-105" onclick="switchPlatform('jd')">京东到家</button>
    </div>

    <!-- 新增指标卡区域 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- 预算金额指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">预算金额</h3>
        <p class="text-2xl font-bold my-4">50,000</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +8.5%</span>
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 月环比 +5.2%</span>
        </div>
      </div>

      <!-- 核销金额指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">核销金额</h3>
        <p class="text-2xl font-bold my-4">32,150</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +15.8%</span>
          <span class="text-xs text-red-500"><i class="fa fa-arrow-down"></i> 月环比 -1.3%</span>
        </div>
      </div>

      <!-- 预算进度指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">预算进度</h3>
        <div class="flex justify-center items-center my-4">
          <div class="relative w-32 h-16 drop-shadow-sm">
            <!-- 外层预算进度半圆 - 增大尺寸 -->
            <svg class="w-full h-full filter drop-shadow-sm" viewBox="0 0 100 50">
              <!-- 背景轨道 -->
              <defs>
                <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#f3f4f6;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#e5e7eb;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="budgetGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                </linearGradient>
              </defs>
              <path d="M 5 50 A 45 45 0 0 1 95 50" fill="none" stroke="url(#bgGradient)" stroke-width="9" stroke-linecap="round"/>
              <path d="M 5 50 A 45 45 0 0 1 95 50" fill="none" stroke="url(#budgetGradient)" stroke-width="9" stroke-linecap="round" stroke-dasharray="141.5" stroke-dashoffset="42.45" id="consumption-progress" class="drop-shadow-sm" />
            </svg>
            <!-- 内层时间进度半圆 - 增大尺寸 -->
            <svg class="absolute inset-0 w-full h-full filter drop-shadow-sm" viewBox="0 0 100 50">
              <defs>
                <linearGradient id="timeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#3b82f6;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                </linearGradient>
              </defs>
              <path d="M 15 50 A 35 35 0 0 1 85 50" fill="none" stroke="url(#bgGradient)" stroke-width="7" stroke-linecap="round"/>
              <path d="M 15 50 A 35 35 0 0 1 85 50" fill="none" stroke="url(#timeGradient)" stroke-width="7" stroke-linecap="round" stroke-dasharray="110" stroke-dashoffset="38.5" class="drop-shadow-sm" />
            </svg>
            <!-- 中间文字 - 调整位置避免重叠但保持叠加样式 -->
            <div class="absolute inset-0 flex flex-col items-center justify-center pt-10">
              <span class="text-xl font-bold text-gray-800 drop-shadow-sm">70%</span>
              <span class="text-xs text-gray-500 mt-1">时间进度: 60%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 活动GMV指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">活动GMV</h3>
        <p class="text-2xl font-bold my-4">78,900</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +8.7%</span>
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 月环比 +2.1%</span>
        </div>
      </div>

      <!-- 活动费比指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">活动费比</h3>
        <p class="text-2xl font-bold my-4">18.5%</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-red-500"><i class="fa fa-arrow-up"></i> 年同比 +2.3pp</span>
          <span class="text-xs text-green-500"><i class="fa fa-arrow-down"></i> 月环比 -0.8pp</span>
        </div>
      </div>

      <!-- 活动ROI指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">活动ROI</h3>
        <p class="text-2xl font-bold my-4">3.2</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +0.6</span>
          <span class="text-xs text-red-500"><i class="fa fa-arrow-down"></i> 月环比 -0.3</span>
        </div>
      </div>

      <!-- GMV指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">GMV</h3>
        <p class="text-2xl font-bold my-4">123,456</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +12.3%</span>
          <span class="text-xs text-red-500"><i class="fa fa-arrow-down"></i> 月环比 -4.5%</span>
        </div>
      </div>

      <!-- 全量费比指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">全量费比</h3>
        <p class="text-2xl font-bold my-4">12.3%</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-red-500"><i class="fa fa-arrow-up"></i> 年同比 +1.5pp</span>
          <span class="text-xs text-red-500"><i class="fa fa-arrow-up"></i> 月环比 +0.4pp</span>
        </div>
      </div>

      <!-- RIO指标卡 -->
      <div class="bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
        <h3 class="text-sm text-gray-500 font-medium mb-2">RIO</h3>
        <p class="text-2xl font-bold my-4">2.8</p>
        <div class="flex flex-col space-y-1 mt-1">
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 年同比 +0.4</span>
          <span class="text-xs text-green-500"><i class="fa fa-arrow-up"></i> 月环比 +0.2</span>
        </div>
      </div>
    </div>

    <!-- 核销费用趋势图 - 只在全平台显示 -->
    <div id="expenseChartContainer" class="bg-white rounded-xl shadow-lg border border-gray-100 mb-8 overflow-hidden">
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fa fa-line-chart mr-3 text-green-600"></i>
          各平台核销费用趋势分析
        </h3>
        <p class="text-sm text-gray-600 mt-1">实时监控各平台核销费用变化情况</p>
      </div>
      <div class="p-6">
        <div class="chart-container h-80 relative bg-gradient-to-br from-gray-50 to-white rounded-xl border border-gray-100 p-4 shadow-inner">
          <canvas id="expenseChart" class="rounded-lg"></canvas>
        </div>
      </div>
    </div>

    <!-- 平台数据图表容器 - 优化布局 -->
    <div id="platformChartContainer" class="bg-white rounded-xl shadow-lg border border-gray-100 mb-8 hidden overflow-hidden">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fa fa-line-chart mr-3 text-blue-600"></i>
          平台数据趋势分析
        </h3>
        <p class="text-sm text-gray-600 mt-1">实时监控各平台核销金额与费比变化</p>
      </div>
      <div class="p-6">
        <div class="chart-container h-96 relative bg-gradient-to-br from-gray-50 to-white rounded-xl border border-gray-100 p-4 shadow-inner">
          <canvas id="platformChart" class="rounded-lg"></canvas>
        </div>
      </div>
    </div>

    <!-- 平台数据表格容器 - 只在单平台显示 -->
    <div id="platformTablesContainer" class="space-y-8 mb-8 hidden">
      <!-- 第一个表格：活动方案数据 -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-gray-100">
          <h3 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fa fa-list-alt mr-3 text-purple-600"></i>
            活动方案数据表
          </h3>
          <p class="text-sm text-gray-600 mt-1">活动方案详情及预算执行情况</p>
        </div>
        <div class="overflow-x-auto">
          <table id="activityPlanTable" class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动类型</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">方案名称</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动名称</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">机制名称</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">机制类型</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">券力度</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">券门槛</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">券面额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动时间</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预算金额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD核销金额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD核销进度</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD时间进度</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预算余额</th>
              </tr>
            </thead>
            <tbody id="activityPlanTableBody" class="bg-white divide-y divide-gray-200">
              <!-- 数据将通过JavaScript动态填充 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 第二个表格：活动效果数据 -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-100">
          <h3 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fa fa-table mr-3 text-green-600"></i>
            活动效果数据表
          </h3>
          <p class="text-sm text-gray-600 mt-1">各方案活动效果及核销情况统计</p>
        </div>
        <div class="overflow-x-auto">
          <table id="activityEffectTable" class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">方案名称</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动类型</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">机制类型</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">机制</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">折扣力度</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">券门槛</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">券面额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当日核销金额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当日活动GMV</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">活动费比</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD核销金额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD活动GMV</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MTD活动费比</th>
              </tr>
            </thead>
            <tbody id="activityEffectTableBody" class="bg-white divide-y divide-gray-200">
              <!-- 数据将通过JavaScript动态填充 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- 四象限容器 - 已删除十字箭头 -->
    <div id="quadrant-container" class="relative">      
      <!-- 坐标轴标签（保留标签，删除十字线） -->
      <div class="hidden md:block axis-label bottom-0 left-1/2 transform translate-x-[-40%] -translate-y-full mb-2">
        <i class="fa fa-long-arrow-right mr-1"></i> 
      </div>
      <div class="hidden md:block axis-label top-1/2 right-0 transform -translate-y-1/2 translate-x-full ml-2 writing-mode:vertical-rl">
        <span class="axis-title"></span>
        <i class="fa fa-long-arrow-up ml-1"></i>
      </div>
      
      <!-- 四象限布局 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-20">
        <!-- 第一行第一列：高量低效 -->
        <div class="quadrant-card">
          <div class="bg-hvle p-4 border-b border-gray-100">
            <h2 class="text-xl font-bold text-hvle-text">高量低效</h2>
            <p class="text-gray-600 mt-1 text-sm"><span class="font-medium">说明：</span>ROI&lt;均值，GMV占比大</p>
          </div>
          <div class="flex flex-col md:flex-row">
            <!-- 美团列 -->
            <div class="platform-column">
              <div class="platform-header bg-meituan">美团</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">3.9</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">53.9%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">63.0%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('美团-高量低效券数明细', [
                       {name: '满200减50', owner: '平台补贴', type: '通用券'},
                       {name: '满100减20', owner: '品牌联合', type: '品类券'},
                       {name: '新用户专享券', owner: '平台补贴', type: '新人券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">9 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 饿了么列 -->
            <div class="platform-column">
              <div class="platform-header bg-eleme">饿了么</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">4.4</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">47.0%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">52.6%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('饿了么-高量低效券数明细', [
                       {name: '满150减30', owner: '平台补贴', type: '通用券'},
                       {name: '品类券', owner: '商家承担', type: '品类券'},
                       {name: '周末券', owner: '平台+商家', type: '时段券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">13 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 京东到家列 -->
            <div class="platform-column">
              <div class="platform-header bg-jd">京东到家</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">3.2</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">41.5%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">58.3%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('京东到家-高量低效券数明细', [
                       {name: '新用户券', owner: '平台补贴', type: '新人券'},
                       {name: '满99减15', owner: '平台补贴', type: '通用券'},
                       {name: '品类专享', owner: '商家承担', type: '品类券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">11 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
          </div>
          <div class="p-3 bg-gray-50 text-sm text-gray-600 border-t border-gray-100">
            策略建议：优化券效，降低无效发券，调整使用门槛
          </div>
        </div>
        
        <!-- 第一行第二列：优质双高 -->
         <div class="quadrant-card">
           <div class="bg-hq p-4 border-b border-gray-100">
             <h2 class="text-xl font-bold text-hq-text">优质双高</h2>
             <p class="text-gray-600 mt-1 text-sm"><span class="font-medium">说明：</span>ROI&gt;均值，GMV占比大</p>
          </div>
          <div class="flex flex-col md:flex-row">
            <!-- 美团列 -->
            <div class="platform-column">
              <div class="platform-header bg-meituan">美团</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">5.9</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">37.9%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">28.6%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('美团-优质双高券数明细', [
                       {name: '满300减100', owner: '平台+商家', type: '通用券'},
                       {name: '品类专享券', owner: '商家承担', type: '品类券'},
                       {name: '会员日特惠', owner: '平台补贴', type: '会员券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">12 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 饿了么列 -->
            <div class="platform-column">
              <div class="platform-header bg-eleme">饿了么</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">6.0</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">42.3%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">34.8%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('饿了么-优质双高券数明细', [
                       {name: '满200减80', owner: '平台+商家', type: '通用券'},
                       {name: '周末特惠券', owner: '平台补贴', type: '时段券'},
                       {name: '爆款专享', owner: '商家承担', type: '商品券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">15 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 京东到家列 -->
            <div class="platform-column">
              <div class="platform-header bg-jd">京东到家</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">5.2</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">35.7%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">31.2%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('京东到家-优质双高券数明细', [
                       {name: '满150减50', owner: '平台+商家', type: '通用券'},
                       {name: '会员券', owner: '平台补贴', type: '会员券'},
                       {name: '限时折扣', owner: '商家承担', type: '时段券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">10 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
          </div>
          <div class="p-3 bg-gray-50 text-sm text-gray-600 border-t border-gray-100">
            策略建议：扩大覆盖范围，增加预算投入，复制成功模式
          </div>
        </div>
        
        <!-- 第二行第一列：长尾双低 -->
         <div class="quadrant-card">
           <div class="bg-ltl p-4 border-b border-gray-100">
             <h2 class="text-xl font-bold text-ltl-text">长尾双低</h2>
             <p class="text-gray-600 mt-1 text-sm"><span class="font-medium">说明：</span>ROI&lt;均值，GMV占比小</p>
          </div>
          <div class="flex flex-col md:flex-row">
            <!-- 美团列 -->
            <div class="platform-column">
              <div class="platform-header bg-meituan">美团</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">3.7</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">4.2%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">5.6%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('美团-长尾双低券数明细', [
                       {name: '满50减5', owner: '商家承担', type: '通用券'},
                       {name: '指定商品券', owner: '商家承担', type: '商品券'},
                       {name: '临期特惠券', owner: '商家承担', type: '时段券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">30 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 饿了么列 -->
            <div class="platform-column">
              <div class="platform-header bg-eleme">饿了么</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">3.7</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">6.6%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">9.4%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('饿了么-长尾双低券数明细', [
                       {name: '小额通用券', owner: '商家承担', type: '通用券'},
                       {name: '临期特惠券', owner: '商家承担', type: '时段券'},
                       {name: '特定商品', owner: '商家承担', type: '商品券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">47 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 京东到家列 -->
            <div class="platform-column">
              <div class="platform-header bg-jd">京东到家</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">3.0</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">5.8%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">7.2%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('京东到家-长尾双低券数明细', [
                       {name: '满60减6', owner: '商家承担', type: '通用券'},
                       {name: '特定品类券', owner: '商家承担', type: '品类券'},
                       {name: '清仓券', owner: '商家承担', type: '商品券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">35 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
          </div>
          <div class="p-3 bg-gray-50 text-sm text-gray-600 border-t border-gray-100">
            策略建议：停止发券，合并券池，评估是否下架该类活动
          </div>
        </div>
        
        <!-- 第二行第二列：高效低量 -->
        <div class="quadrant-card">
          <div class="bg-hele p-4 border-b border-gray-100">
            <h2 class="text-xl font-bold text-hele-text">高效低量</h2>
            <p class="text-gray-600 mt-1 text-sm"><span class="font-medium">说明：</span>ROI&gt;均值，GMV占比小</p>
          </div>
          <div class="flex flex-col md:flex-row">
            <!-- 美团列 -->
            <div class="platform-column">
              <div class="platform-header bg-meituan">美团</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">6.9</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">3.9%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">2.8%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('美团-高效低量券数明细', [
                       {name: '满500减200', owner: '平台+商家', type: '高端券'},
                       {name: '会员专享券', owner: '平台补贴', type: '会员券'},
                       {name: '高端用户券', owner: '平台补贴', type: '定向券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">42 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 饿了么列 -->
            <div class="platform-column">
              <div class="platform-header bg-eleme">饿了么</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">6.8</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">4.1%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">3.2%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('饿了么-高效低量券数明细', [
                       {name: '满400减150', owner: '平台+商家', type: '高端券'},
                       {name: '高端用户券', owner: '平台补贴', type: '定向券'},
                       {name: '精品专享', owner: '商家承担', type: '商品券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">37 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
            
            <!-- 京东到家列 -->
            <div class="platform-column">
              <div class="platform-header bg-jd">京东到家</div>
              <div class="space-y-1">
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-line-chart mr-1"></i> ROI</span>
                  <span class="font-medium">5.7</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-shopping-cart mr-1"></i> GMV占比</span>
                  <span class="font-medium">3.5%</span>
                </div>
                <div class="metric-item">
                  <span class="text-gray-600 text-sm"><i class="fa fa-percent mr-1"></i> TS占比</span>
                  <span class="font-medium">2.5%</span>
                </div>
                <div class="metric-item clickable" onclick="showCouponDetail('京东到家-高效低量券数明细', [
                       {name: '满300减100', owner: '平台+商家', type: '高端券'},
                       {name: '精品专享券', owner: '商家承担', type: '商品券'},
                       {name: '高端会员', owner: '平台补贴', type: '会员券'}
                     ])">
                  <span class="text-gray-600 text-sm"><i class="fa fa-ticket mr-1"></i> 券数</span>
                  <span class="font-medium text-blue-600">28 <i class="fa fa-angle-right ml-1 text-xs"></i></span>
                </div>
              </div>
            </div>
          </div>
          <div class="p-3 bg-gray-50 text-sm text-gray-600 border-t border-gray-100">策略建议：扩大曝光，增加用户覆盖，提升活动规模</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 券数明细弹窗 -->
  <div id="couponDetailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-auto m-4 shadow-xl">
      <div class="p-5 border-b border-gray-100 flex justify-between items-center">
        <h3 id="modalTitle" class="text-lg font-bold text-gray-800">券数明细</h3>
        <button onclick="hideCouponDetail()" class="text-gray-400 hover:text-gray-600">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-5">
        <!-- 表头 -->
        <div class="grid grid-cols-4 gap-2 font-medium text-sm text-gray-500 mb-3 pb-2 border-b">
          <div class="col-span-1">序号</div>
          <div class="col-span-1">券名称</div>
          <div class="col-span-1">活动归属</div>
          <div class="col-span-1">券类型</div>
        </div>
        
        <!-- 券明细内容 -->
        <div id="couponList" class="space-y-1">
          <!-- 内容将通过JS动态填充 -->
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-100 flex justify-end">
        <button onclick="hideCouponDetail()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-gray-700 transition-colors">
          关闭
        </button>
      </div>
    </div>
  </div>

  <script>
    // 平台切换功能
    function switchPlatform(platform) {
      // 更新Tab样式
      document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`tab-${platform}`).classList.add('active');
      
      // 控制四象限和图表显示
      const quadrantContainer = document.getElementById('quadrant-container');
      const chartContainer = document.getElementById('platformChartContainer');
      const expenseContainer = document.getElementById('expenseChartContainer');
      const tablesContainer = document.getElementById('platformTablesContainer');
      
      if (platform === 'all') {
        quadrantContainer.style.display = 'block';
        chartContainer.classList.add('hidden');
        expenseContainer.classList.remove('hidden');
        tablesContainer.classList.add('hidden'); // 隐藏表格
        setTimeout(() => {
          renderExpenseChart();
        }, 100);
      } else {
        quadrantContainer.style.display = 'none';
        chartContainer.classList.remove('hidden');
        expenseContainer.classList.add('hidden');
        tablesContainer.classList.remove('hidden'); // 显示表格
        setTimeout(() => {
          renderPlatformChart(platform);
          loadPlatformTableData(platform); // 加载表格数据
        }, 100);
      }
    }
    
    // 渲染全平台核销费用趋势图
    function renderExpenseChart() {
      console.log('开始渲染全平台核销费用趋势图');
      updateStatus('渲染全平台图表...', '🎯');
      
      // 检查Chart.js是否可用
      if (!checkChartJS()) {
        console.error('Chart.js不可用，无法渲染图表');
        updateStatus('Chart.js不可用', '❌');
        return;
      }
      
      const canvas = document.getElementById('expenseChart');
      if (!canvas) {
        console.error('找不到expenseChart元素');
        updateStatus('找不到图表容器', '❌');
        return;
      }
      
      console.log('Canvas元素已找到，尺寸:', canvas.width, 'x', canvas.height);
      
      // 简化的模拟数据
      const dates = ['12-01', '12-02', '12-03', '12-04', '12-05'];
      const data = {
        meituan: [125000, 135000, 145000, 155000, 165000],
        eleme: [98000, 108000, 118000, 128000, 138000],
        jd: [78000, 85000, 92000, 99000, 108000]
      };
      
      // 销毁已有图表
      if (window.expenseChartInstance) {
        window.expenseChartInstance.destroy();
        window.expenseChartInstance = null;
      }
      
      try {
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          console.error('无法获取Canvas 2D上下文');
          return;
        }
        
        window.expenseChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: '美团',
                data: data.meituan,
                borderColor: '#FFD161',
                backgroundColor: '#FFD16120',
                borderWidth: 3,
                fill: true
              },
              {
                label: '饿了么',
                data: data.eleme,
                borderColor: '#0086FF',
                backgroundColor: '#0086FF20',
                borderWidth: 3,
                fill: true
              },
              {
                label: '京东到家',
                data: data.jd,
                borderColor: '#01af00',
                backgroundColor: '#01af0020',
                borderWidth: 3,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '各平台核销费用趋势对比',
                font: { size: 16, weight: 'bold' }
              },
              legend: {
                position: 'bottom'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: '核销费用' }
              }
            }
          }
        });
        
        console.log('全平台图表创建成功！');
        updateStatus('全平台图表创建成功！', '✅');
      } catch (error) {
        console.error('图表创建失败:', error);
        updateStatus('图表创建失败: ' + error.message, '❌');
      }
    }
    
    // 渲染单平台数据图表
    function renderPlatformChart(platform) {
      console.log(`开始渲染平台图表: ${platform}`);
      updateStatus(`渲染${platform}图表...`, '🎯');
      
      if (!checkChartJS()) {
        console.error('Chart.js不可用');
        updateStatus('Chart.js不可用', '❌');
        return;
      }
      
      const canvas = document.getElementById('platformChart');
      if (!canvas) {
        console.error('找不到platformChart元素');
        updateStatus('找不到平台图表容器', '❌');
        return;
      }
      
      const dates = ['12-01', '12-02', '12-03', '12-04', '12-05'];
      let chartData, platformName;
      
      switch(platform) {
        case 'meituan':
          platformName = '美团';
          chartData = {
            amounts: [890000, 950000, 1020000, 1150000, 1180000],
            feeRatio: [12.5, 12.8, 13.2, 14.0, 14.3]
          };
          break;
        case 'eleme':
          platformName = '饿了么';
          chartData = {
            amounts: [650000, 680000, 720000, 820000, 840000],
            feeRatio: [11.8, 12.1, 12.5, 13.4, 13.7]
          };
          break;
        case 'jd':
          platformName = '京东到家';
          chartData = {
            amounts: [480000, 510000, 540000, 610000, 620000],
            feeRatio: [13.2, 13.5, 13.9, 14.8, 15.1]
          };
          break;
        default:
          return;
      }
      
      // 销毁已有图表
      if (window.platformChartInstance) {
        window.platformChartInstance.destroy();
        window.platformChartInstance = null;
      }
      
      try {
        const ctx = canvas.getContext('2d');
        window.platformChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [
              {
                label: '核销金额',
                data: chartData.amounts,
                backgroundColor: '#2196F3',
                yAxisID: 'y'
              },
              {
                label: '费比%',
                data: chartData.feeRatio,
                type: 'line',
                borderColor: '#4CAF50',
                backgroundColor: 'transparent',
                borderWidth: 3,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: platformName + '数据趋势分析',
                font: { size: 16, weight: 'bold' }
              },
              legend: { position: 'bottom' }
            },
            scales: {
              y: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: '核销金额' },
                beginAtZero: true
              },
              y1: {
                type: 'linear',
                position: 'right',
                title: { display: true, text: '费比(%)' },
                grid: { drawOnChartArea: false },
                min: 0,
                max: 20
              }
            }
          }
        });
        
        console.log(`${platformName}图表创建成功！`);
        updateStatus(`${platformName}图表创建成功！`, '✅');
      } catch (error) {
        console.error(`创建${platformName}图表失败:`, error);
        updateStatus(`创建图表失败: ${error.message}`, '❌');
      }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM加载完成，开始初始化');
      updateStatus('页面加载完成...', '⏳');
      
      // 初始化日期筛选器
      initializeDateFilter();
      
      // 等待Chart.js加载完成
      waitForChartJS().then(() => {
        console.log('Chart.js已就绪，版本:', Chart.version);
        updateStatus('Chart.js加载成功...', '✅');
        setTimeout(initializeCharts, 300);
      }).catch((error) => {
        console.error('Chart.js加载失败:', error);
        updateStatus('Chart.js加载失败，请刷新页面', '❌');
      });
    });
    
    function initializeCharts() {
      updateStatus('检查Chart.js库...', '⏳');
      
      if (!checkChartJS()) {
        console.error('Chart.js仍然不可用');
        updateStatus('Chart.js加载失败，请刷新页面', '❌');
        return;
      }
      
      updateStatus('Chart.js加载成功，检查元素...', '✅');
      console.log('Chart.js版本:', Chart.version);
      
      const expenseCanvas = document.getElementById('expenseChart');
      const platformCanvas = document.getElementById('platformChart');
      
      if (!expenseCanvas || !platformCanvas) {
        console.error('找不到图表容器元素');
        updateStatus('找不到图表容器元素', '❌');
        return;
      }
      
      updateStatus('开始渲染图表...', '⏳');
      
      // 渲染图表
      renderExpenseChart();
      switchPlatform('all');
      
      updateStatus('图表初始化完成！', '✅');
      
      // 5秒后隐藏状态条
      setTimeout(() => {
        const statusDiv = document.getElementById('chartStatus');
        if (statusDiv) {
          statusDiv.style.display = 'none';
        }
      }, 5000);
    }

    // 显示券数明细
    function showCouponDetail(title, coupons) {
      document.getElementById('modalTitle').textContent = title;
      const couponList = document.getElementById('couponList');
      couponList.innerHTML = '';
      
      coupons.forEach((coupon, index) => {
        const item = document.createElement('div');
        item.className = 'grid grid-cols-4 gap-2 items-center p-2 hover:bg-gray-50 rounded coupon-detail-row';
        item.innerHTML = `
          <div class="col-span-1 font-medium">${index + 1}</div>
          <div class="col-span-1">${coupon.name}</div>
          <div class="col-span-1">${coupon.owner}</div>
          <div class="col-span-1">${coupon.type}</div>
        `;
        couponList.appendChild(item);
      });
      
      document.getElementById('couponDetailModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function hideCouponDetail() {
      document.getElementById('couponDetailModal').classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // 调试信息管理
    function toggleDebug() {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
      } else {
        debugInfo.style.display = 'none';
      }
    }
  </script>
  
  <script>
    // 计算时间进度 (当月T-1)
    function calculateTimeProgress() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const dayOfMonth = Math.min(now.getDate() - 1, daysInMonth); // T-1
      return (dayOfMonth / daysInMonth) * 100;
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 计算进度对应的圆环
      const setProgress = (elementId, progress, radius, gapDegree = 0) => {
        const circle = document.getElementById(elementId);
        // 计算实际显示的百分比（考虑缺口)
        const effectiveProgress = gapDegree > 0 ? progress * (1 - gapDegree / (Math.PI * radius * (365/180))) : progress;
        // 半圆周长
        const circumference = Math.PI * radius;
        // 计算缺口对应的像素值
        const gapPixels = gapDegree > 0 ? (gapDegree / (Math.PI * radius * (365/189))) * Math.PI * radius : 0;
        // 设置圆环属性
        circle.style.strokeDasharray = `${circumference} ${gapPixels}`;
        circle.style.strokeDashoffset = circumference - (effectiveProgress / 100) * circumference;
        
        // 更新进度文本
        if (elementId === 'consumption-progress') {
          const textElement = circle.parentElement.querySelector('text');
          if (textElement) {
            textElement.textContent = `${Math.round(progress)}%`;
          }
        }
      };
    
      // 设置消耗进度为75%，无缺口
      setProgress('consumption-progress', 75, 40);
    });
    
    // 渲染平台数据图表 - 参考GMV趋势分析样式
function renderPlatformChart(platform) {
  console.log(`开始渲染平台图表: ${platform}`);
  updateStatus(`渲染${platform}图表...`, '🎯');
  
  // 检查Chart.js是否可用，如果不可用则等待加载
  if (!checkChartJS()) {
    console.log('Chart.js尚未加载，等待加载完成...');
    updateStatus('等待Chart.js加载...', '⏳');
    
    // 等待Chart.js加载完成后再渲染
    waitForChartJS().then(() => {
      console.log('Chart.js加载完成，继续渲染图表');
      renderPlatformChart(platform);
    }).catch(error => {
      console.error('Chart.js加载失败:', error);
      updateStatus('Chart.js加载失败', '❌');
    });
    return;
  }
  
  // 检查Canvas元素是否存在
  const canvas = document.getElementById('platformChart');
  if (!canvas) {
    console.error('找不到platformChart元素');
    updateStatus('找不到平台图表容器', '❌');
    return;
  }
     
  // 检查Canvas容器是否可见
  const container = document.getElementById('platformChartContainer');
  if (container && container.classList.contains('hidden')) {
    console.log('容器不可见，等待显示后再渲染');
    return;
  }
         
         // 模拟数据 - 过去15天
         const dates = ['12-01', '12-02', '12-03', '12-04', '12-05', '12-06', '12-07', '12-08', '12-09', '12-10', '12-11', '12-12', '12-13', '12-14', '12-15'];
         let chartData;
         let platformName;
         
         // 根据平台设置不同数据
         switch(platform) {
           case 'meituan':
             platformName = '美团';
             chartData = {
               // 自然GMV和活动GMV数据
               naturalGMV: [650000, 700000, 750000, 720000, 780000, 830000, 800000, 850000, 900000, 870000, 920000, 970000, 940000, 990000, 1040000],
               activityGMV: [240000, 250000, 270000, 260000, 270000, 290000, 280000, 300000, 320000, 310000, 330000, 350000, 340000, 360000, 380000],
               // 保留费比数据
               totalFeeRatio: [12.5, 12.8, 13.2, 12.9, 13.5, 13.8, 13.4, 14.0, 14.3, 14.0, 14.5, 14.8, 14.5, 15.0, 15.3], // 全量费比
               activityFeeRatio: [18.2, 18.5, 19.0, 18.7, 19.3, 19.6, 19.2, 19.8, 20.1, 19.8, 20.3, 20.6, 20.3, 20.8, 21.1] // 活动费比
             };
             // 计算全量GMV
             chartData.totalGMV = chartData.naturalGMV.map((val, idx) => val + chartData.activityGMV[idx]);
             break;
           case 'eleme':
             platformName = '饿了么';
             chartData = {
               // 自然GMV和活动GMV数据
               naturalGMV: [480000, 500000, 530000, 510000, 550000, 580000, 560000, 600000, 630000, 610000, 650000, 680000, 660000, 700000, 730000],
               activityGMV: [170000, 180000, 190000, 190000, 200000, 210000, 210000, 220000, 230000, 230000, 240000, 250000, 250000, 260000, 270000],
               // 保留费比数据
               totalFeeRatio: [11.8, 12.1, 12.5, 12.2, 12.8, 13.1, 12.8, 13.4, 13.7, 13.4, 13.9, 14.2, 13.9, 14.4, 14.7],
               activityFeeRatio: [17.5, 17.8, 18.2, 17.9, 18.5, 18.8, 18.5, 19.1, 19.4, 19.1, 19.6, 19.9, 19.6, 20.1, 20.4]
             };
             // 计算全量GMV
             chartData.totalGMV = chartData.naturalGMV.map((val, idx) => val + chartData.activityGMV[idx]);
             break;
           case 'jd':
             platformName = '京东到家';
             chartData = {
               // 自然GMV和活动GMV数据
               naturalGMV: [350000, 370000, 390000, 380000, 410000, 430000, 420000, 450000, 470000, 460000, 490000, 510000, 500000, 530000, 550000],
               activityGMV: [130000, 140000, 150000, 140000, 150000, 160000, 150000, 160000, 170000, 160000, 170000, 180000, 170000, 180000, 190000],
               // 保留费比数据
               totalFeeRatio: [13.2, 13.5, 13.9, 13.6, 14.2, 14.5, 14.2, 14.8, 15.1, 14.8, 15.3, 15.6, 15.3, 15.8, 16.1],
               activityFeeRatio: [19.0, 19.3, 19.7, 19.4, 20.0, 20.3, 20.0, 20.6, 20.9, 20.6, 21.1, 21.4, 21.1, 21.6, 21.9]
             };
             // 计算全量GMV
             chartData.totalGMV = chartData.naturalGMV.map((val, idx) => val + chartData.activityGMV[idx]);
             break;
           default:
             console.error(`未知平台: ${platform}`);
             return;
         }
       
         // 销毁已有图表
         if (window.platformChartInstance) {
           console.log('销毁已有平台图表实例');
           window.platformChartInstance.destroy();
           window.platformChartInstance = null;
         }
       
         // 创建新图表
         const ctx = canvas.getContext('2d');
         if (!ctx) {
           console.error('无法获取2D上下文');
           return;
         }
         
         console.log(`创建${platformName}图表，数据:`, chartData);
         
         try {
           window.platformChartInstance = new Chart(ctx, {
             type: 'bar',
             data: {
               labels: dates,
               datasets: [
                 // 1. 全量费比折线图 - 绿色
                 {
                   label: '全量费比',
                   data: chartData.totalFeeRatio,
                   type: 'line',
                   borderColor: '#4CAF50',
                   backgroundColor: 'transparent',
                   borderWidth: 3,
                   tension: 0.4,
                   yAxisID: 'y1',
                   order: 1,
                   pointRadius: 5,
                   pointHoverRadius: 7,
                   pointBackgroundColor: '#4CAF50',
                   pointBorderColor: '#ffffff',
                   pointBorderWidth: 2,
                   pointHoverBackgroundColor: '#4CAF50',
                   pointHoverBorderColor: '#ffffff',
                   pointHoverBorderWidth: 3
                 },
                 // 2. 活动GMV柱状图 - 紫色
                 {
                   label: '活动GMV',
                   data: chartData.activityGMV,
                   backgroundColor: '#9C27B0',
                   borderColor: '#7B1FA2',
                   borderWidth: 1,
                   borderRadius: {
                     topLeft: 4,
                     topRight: 4,
                     bottomLeft: 0,
                     bottomRight: 0
                   },
                   borderSkipped: false,
                   yAxisID: 'y',
                   order: 2,
                   stack: 'GMV' // 堆叠标识
                 },
                 // 3. 活动费比折线图 - 橙色
                 {
                   label: '活动费比',
                   data: chartData.activityFeeRatio,
                   type: 'line',
                   borderColor: '#FF9800',
                   backgroundColor: 'transparent',
                   borderWidth: 3,
                   tension: 0.4,
                   yAxisID: 'y1',
                   order: 3,
                   pointRadius: 5,
                   pointHoverRadius: 7,
                   pointBackgroundColor: '#FF9800',
                   pointBorderColor: '#ffffff',
                   pointBorderWidth: 2,
                   pointHoverBackgroundColor: '#FF9800',
                   pointHoverBorderColor: '#ffffff',
                   pointHoverBorderWidth: 3
                 },
                 // 4. 自然GMV柱状图 - 蓝色
                 {
                   label: '自然GMV',
                   data: chartData.naturalGMV,
                   backgroundColor: '#2196F3',
                   borderColor: '#1976D2',
                   borderWidth: 1,
                   borderRadius: {
                     topLeft: 4,
                     topRight: 4,
                     bottomLeft: 0,
                     bottomRight: 0
                   },
                   borderSkipped: false,
                   yAxisID: 'y',
                   order: 4,
                   stack: 'GMV' // 堆叠标识
                 }
               ]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               interaction: {
                 mode: 'index',
                 intersect: false,
               },
               layout: {
                 padding: {
                   top: 20,
                   bottom: 20,
                   left: 15,
                   right: 15
                 }
               },
               scales: {
                 y: {
                   type: 'linear',
                   display: true,
                   position: 'left',
                   stacked: true, // 启用堆叠
                   title: {
                     display: true,
                     text: '全量GMV',
                     font: {
                       size: 14,
                       weight: 'bold'
                     },
                     color: '#374151'
                   },
                   ticks: {
                     callback: function(value) {
                       return value.toLocaleString();
                     },
                     font: {
                       size: 12
                     },
                     color: '#6b7280',
                     padding: 8
                   },
                   grid: {
                     color: 'rgba(156, 163, 175, 0.15)',
                     lineWidth: 1
                   },
                   beginAtZero: true
                 },
                 y1: {
                   type: 'linear',
                   display: true,
                   position: 'right',
                   title: {
                     display: true,
                     text: '费比(%)',
                     font: {
                       size: 14,
                       weight: 'bold'
                     },
                     color: '#374151'
                   },
                   grid: {
                     drawOnChartArea: false,
                   },
                   ticks: {
                     callback: function(value) {
                       return value + '%';
                     },
                     font: {
                       size: 12
                     },
                     color: '#6b7280',
                     padding: 8
                   },
                   min: 0,
                   max: 25
                 },
                 x: {
                   title: {
                     display: false
                   },
                   ticks: {
                     font: {
                       size: 12,
                       weight: '500'
                     },
                     color: '#374151',
                     maxRotation: 0,
                     padding: 8
                   },
                   grid: {
                     display: false
                   }
                 }
               },
               plugins: {
                 title: {
                   display: true,
                   text: platformName + '数据趋势分析',
                   font: {
                     size: 18,
                     weight: 'bold'
                   },
                   color: '#1f2937',
                   padding: {
                     top: 10,
                     bottom: 20
                   }
                 },
                 legend: {
                   position: 'bottom',
                   align: 'center',
                   labels: {
                     usePointStyle: true,
                     pointStyle: function(context) {
                       // 根据数据集索引设置点样式
                       if (context.datasetIndex === 0 || context.datasetIndex === 2) {
                         return 'circle'; // 费比类（折线）
                       } else {
                         return 'rect'; // GMV类（柱状）
                       }
                     },
                     font: {
                       size: 13,
                       weight: '500'
                     },
                     color: '#374151',
                     padding: 20,
                     boxWidth: 15,
                     boxHeight: 15
                   }
                 },
                 tooltip: {
                   backgroundColor: 'rgba(17, 24, 39, 0.95)',
                   titleColor: '#ffffff',
                   bodyColor: '#ffffff',
                   borderColor: 'rgba(156, 163, 175, 0.3)',
                   borderWidth: 1,
                   cornerRadius: 8,
                   padding: 12,
                   titleFont: {
                     size: 14,
                     weight: 'bold'
                   },
                   bodyFont: {
                     size: 13
                   },
                   callbacks: {
                     title: function(context) {
                       return platformName + ' - ' + context[0].label;
                     },
                     label: function(context) {
                       let label = context.dataset.label || '';
                       if (label) {
                         label += ': ';
                       }
                       if (label.includes('GMV')) {
                         // GMV数据
                         label += context.raw.toLocaleString();
                       } else {
                         // 费比数据
                         label += context.raw + '%';
                       }
                       return label;
                     },
                     afterLabel: function(context) {
                       // 在所有数据点上都显示全量GMV信息
                       const index = context.dataIndex;
                       const totalGMV = chartData.totalGMV[index];
                       return '全量GMV: ' + totalGMV.toLocaleString();
                     }
                   }
                 }
               },
               elements: {
                 point: {
                   hoverRadius: 8
                 },
                 line: {
                   borderJoinStyle: 'round'
                 }
               },
               animation: {
                 duration: 1200,
                 easing: 'easeInOutQuart'
               }
             }
           });
           
           console.log(`${platformName}图表创建成功`);
         } catch (error) {
           console.error(`创建${platformName}图表失败:`, error);
         }
       }
       
       // 渲染核销费用趋势图
       function renderExpenseChart() {
         console.log('开始渲染全平台核销费用趋势图');
         
         // 检查Canvas元素是否存在
         const canvas = document.getElementById('expenseChart');
         if (!canvas) {
           console.error('找不到expenseChart元素');
           return;
         }
         
         // 检查Canvas容器是否可见
         const container = document.getElementById('expenseChartContainer');
         if (container && container.classList.contains('hidden')) {
           console.log('容器不可见，等待显示后再渲染');
           return;
         }
         
         // 模拟数据 - 过去15天各平台核销费用
         const dates = ['12-01', '12-02', '12-03', '12-04', '12-05', '12-06', '12-07', '12-08', '12-09', '12-10', '12-11', '12-12', '12-13', '12-14', '12-15'];
         const platformData = {
           meituan: {
             name: '美团',
             color: '#FFD161',
             verificationFee: [125000, 148000, 172000, 158000, 185000, 210000, 195000, 225000, 248000, 235000, 265000, 290000, 275000, 305000, 335000]
           },
           eleme: {
             name: '饿了么',
             color: '#0086FF', 
             verificationFee: [98000, 112000, 125000, 118000, 135000, 152000, 145000, 165000, 182000, 175000, 195000, 215000, 205000, 225000, 245000]
           },
           jd: {
             name: '京东到家',
             color: '#01af00',
             verificationFee: [78000, 88000, 98000, 92000, 105000, 118000, 112000, 128000, 142000, 135000, 152000, 168000, 160000, 178000, 195000]
           }
         };

         // 销毁已有图表
         if (window.expenseChartInstance) {
           console.log('销毁已有全平台图表实例');
           window.expenseChartInstance.destroy();
           window.expenseChartInstance = null;
         }

         // 创建新图表
         const ctx = canvas.getContext('2d');
         if (!ctx) {
           console.error('无法获取2D上下文');
           return;
         }

         // 准备数据集
         const datasets = Object.values(platformData).map(platform => ({
           label: platform.name,
           data: platform.verificationFee,
           borderColor: platform.color,
           backgroundColor: platform.color + '20', // 半透明填充
           borderWidth: 3,
           tension: 0.4,
           fill: true,
           pointRadius: 5,
           pointHoverRadius: 7,
           pointBackgroundColor: platform.color,
           pointHoverBackgroundColor: '#ffffff',
           pointBorderColor: '#ffffff',
           pointHoverBorderColor: platform.color,
           pointBorderWidth: 2,
           pointHoverBorderWidth: 3
         }));
         
         console.log('准备数据集:', datasets);

         try {
           window.expenseChartInstance = new Chart(ctx, {
             type: 'line',
             data: {
               labels: dates,
               datasets: datasets
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               interaction: {
                 mode: 'index',
                 intersect: false,
               },
               layout: {
                 padding: {
                   top: 20,
                   bottom: 20,
                   left: 15,
                   right: 15
                 }
               },
               scales: {
                 y: {
                   type: 'linear',
                   display: true,
                   position: 'left',
                   title: {
                     display: true,
                     text: '核销费用',
                     font: {
                       size: 14,
                       weight: 'bold'
                     },
                     color: '#374151'
                   },
                   ticks: {
                     callback: function(value) {
                       return value.toLocaleString();
                     },
                     font: {
                       size: 12
                     },
                     color: '#6b7280',
                     padding: 8
                   },
                   grid: {
                     color: 'rgba(156, 163, 175, 0.15)',
                     lineWidth: 1
                   },
                   beginAtZero: true
                 },
                 x: {
                   title: {
                     display: false
                   },
                   ticks: {
                     font: {
                       size: 12,
                       weight: '500'
                     },
                     color: '#374151',
                     maxRotation: 0,
                     padding: 8
                   },
                   grid: {
                     display: false
                   }
                 }
               },
               plugins: {
                 title: {
                   display: true,
                   text: '各平台核销费用趋势对比',
                   font: {
                     size: 18,
                     weight: 'bold'
                   },
                   color: '#1f2937',
                   padding: {
                     top: 10,
                     bottom: 20
                   }
                 },
                 legend: {
                   position: 'bottom',
                   align: 'center',
                   labels: {
                     usePointStyle: true,
                     pointStyle: 'circle',
                     font: {
                       size: 13,
                       weight: '500'
                     },
                     color: '#374151',
                     padding: 20,
                     boxWidth: 15,
                     boxHeight: 15
                   }
                 },
                 tooltip: {
                   backgroundColor: 'rgba(17, 24, 39, 0.95)',
                   titleColor: '#ffffff',
                   bodyColor: '#ffffff',
                   borderColor: 'rgba(156, 163, 175, 0.3)',
                   borderWidth: 1,
                   cornerRadius: 8,
                   padding: 12,
                   titleFont: {
                     size: 14,
                     weight: 'bold'
                   },
                   bodyFont: {
                     size: 13
                   },
                   callbacks: {
                     title: function(context) {
                       return '核销费用 - ' + context[0].label;
                     },
                     label: function(context) {
                       let label = context.dataset.label || '';
                       if (label) {
                         label += ': ';
                       }
                       label += context.raw.toLocaleString();
                       return label;
                     }
                   }
                 }
               },
               elements: {
                 point: {
                   hoverRadius: 8
                 },
                 line: {
                   borderJoinStyle: 'round'
                 }
               },
               animation: {
                 duration: 1200,
                 easing: 'easeInOutQuart'
               }
             }
           });
           
           console.log('全平台核销费用趋势图创建成功');
         } catch (error) {
           console.error('创建全平台图表失败:', error);
         }
       }
     </script>

<script>
    // 状态更新函数
    function updateStatus(message, icon) {
      const statusText = document.getElementById('statusText');
      const statusIcon = document.getElementById('statusIcon');
      
      if (statusText) {
        statusText.textContent = message;
      }
      if (statusIcon) {
        statusIcon.textContent = icon;
      }
      
      console.log('状态更新:', icon, message);
    }
    
    // 日期筛选器功能
    function initializeDateFilter() {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth(); // 注意：getMonth()返回0-11，所以8月是7
      
      // 计算当月第一天（当月1号）
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      
      // 计算当月T-1日（今天减去1天，即昨天）
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);
      
      // 如果昨天不在当月，则使用当月最后一天
      let endDate = yesterday;
      if (yesterday.getMonth() !== currentMonth || yesterday.getFullYear() !== currentYear) {
        // 昨天不在当月，使用当月最后一天
        endDate = new Date(currentYear, currentMonth + 1, 0);
      }
      
      // 格式化为 YYYY-MM-DD（使用本地日期避免时区问题）
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      // 设置默认日期
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      
      if (startDateInput && endDateInput) {
        const formattedStartDate = formatDate(firstDayOfMonth);
        const formattedEndDate = formatDate(endDate);
        
        startDateInput.value = formattedStartDate;
        endDateInput.value = formattedEndDate;
        
        console.log('默认日期设置:', {
          开始日期: formattedStartDate,
          结束日期: formattedEndDate,
          当前月份: currentMonth + 1, // 显示时+1，因为getMonth()返回0-11
          今天: formatDate(today),
          昨天: formatDate(yesterday),
          第一天计算: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`
        });
        
        // 更新显示
        updateDateRangeDisplay();
        
        // 绑定事件
        const applyButton = document.getElementById('applyDateFilter');
        const resetButton = document.getElementById('resetDateFilter');
        
        if (applyButton) {
          applyButton.addEventListener('click', handleDateFilterApply);
        }
        
        if (resetButton) {
          resetButton.addEventListener('click', handleDateFilterReset);
        }
        
        // 监听日期输入框变化
        startDateInput.addEventListener('change', updateDateRangeDisplay);
        endDateInput.addEventListener('change', updateDateRangeDisplay);
      }
    }
    
    // 更新日期范围显示
    function updateDateRangeDisplay() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const displayElement = document.getElementById('dateRangeDisplay');
      
      if (displayElement && startDate && endDate) {
        displayElement.textContent = `当前选择：${startDate} 至 ${endDate}`;
      }
    }
    
    // 应用日期筛选
    function handleDateFilterApply() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('请选择开始日期和结束日期');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('开始日期不能大于结束日期');
        return;
      }
      
      console.log('应用日期筛选:', startDate, '至', endDate);
      
      // 这里可以添加重新加载图表数据的逻辑
      updateChartsWithDateRange(startDate, endDate);
      
      // 显示成功消息
      updateStatus('日期筛选已应用', '✓');
      setTimeout(() => {
        const statusDiv = document.getElementById('chartStatus');
        if (statusDiv) {
          statusDiv.style.display = 'none';
        }
      }, 2000);
    }
    
    // 重置日期筛选
    function handleDateFilterReset() {
      initializeDateFilter();
      console.log('日期筛选已重置');
      
      // 重新加载默认数据
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      updateChartsWithDateRange(startDate, endDate);
      
      updateStatus('日期筛选已重置', '✓');
      setTimeout(() => {
        const statusDiv = document.getElementById('chartStatus');
        if (statusDiv) {
          statusDiv.style.display = 'none';
        }
      }, 2000);
    }
    
    // 根据日期范围更新图表数据
    function updateChartsWithDateRange(startDate, endDate) {
      console.log('更新图表数据范围:', startDate, '-', endDate);
      
      // 计算日期范围内的天数
      const start = new Date(startDate);
      const end = new Date(endDate);
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      
      console.log(`日期范围共${daysDiff}天`);
      
      // 重新渲染所有图表
      if (typeof renderExpenseChart === 'function') {
        renderExpenseChart();
      }
      
      // 重新渲染当前激活的平台图表
      const activeTab = document.querySelector('.platform-tab.active');
      if (activeTab) {
        const platform = activeTab.id.replace('tab-', '');
        if (platform !== 'all' && typeof renderPlatformChart === 'function') {
          renderPlatformChart(platform);
        }
      }
    }
    
    // 加载平台表格数据
    function loadPlatformTableData(platform) {
      console.log(`加载${platform}平台表格数据`);
      
      // 模拟数据
      const mockData = generateMockTableData(platform);
      
      // 填充第一个表格（活动方案数据）
      populateActivityPlanTable(mockData.activityPlan);
      
      // 填充第二个表格（活动效果数据）
      populateActivityEffectTable(mockData.activityEffect);
    }
    
    // 生成模拟表格数据
    function generateMockTableData(platform) {
      const platformNames = {
        'meituan': '美团',
        'eleme': '饿了么',
        'jd': '京东到家'
      };
      
      const platformName = platformNames[platform] || platform;
      
      // 活动效果数据（第一个表格）
      const activityEffect = [
        {
          planName: `${platformName}拉新活动`,
          activityType: '拉新',
          mechanismType: '满减券',
          mechanism: '满200减50',
          discountRate: '25%',
          threshold: '200元',
          faceValue: '50元',
          dailyAmount: '25,680',
          dailyGMV: '156,800',
          activityFeeRatio: '16.4%',
          mtdAmount: '385,200',
          mtdGMV: '2,341,600',
          mtdFeeRatio: '16.5%'
        },
        {
          planName: `${platformName}促销方案`,
          activityType: '促销',
          mechanismType: '折扣券',
          mechanism: '8.5折券',
          discountRate: '15%',
          threshold: '150元',
          faceValue: '22.5元',
          dailyAmount: '18,450',
          dailyGMV: '122,900',
          activityFeeRatio: '15.0%',
          mtdAmount: '276,750',
          mtdGMV: '1,843,500',
          mtdFeeRatio: '15.0%'
        },
        {
          planName: `${platformName}会员专享`,
          activityType: '会员',
          mechanismType: '专享券',
          mechanism: '满100减30',
          discountRate: '30%',
          threshold: '100元',
          faceValue: '30元',
          dailyAmount: '12,300',
          dailyGMV: '86,100',
          activityFeeRatio: '14.3%',
          mtdAmount: '184,500',
          mtdGMV: '1,291,500',
          mtdFeeRatio: '14.3%'
        },
        {
          planName: `${platformName}夏日特惠`,
          activityType: '季节性',
          mechanismType: '满减券',
          mechanism: '满300减80',
          discountRate: '26.7%',
          threshold: '300元',
          faceValue: '80元',
          dailyAmount: '32,400',
          dailyGMV: '162,000',
          activityFeeRatio: '20.0%',
          mtdAmount: '486,000',
          mtdGMV: '2,430,000',
          mtdFeeRatio: '20.0%'
        },
        {
          planName: `${platformName}限时抢购`,
          activityType: '限时',
          mechanismType: '秒杀券',
          mechanism: '满500减150',
          discountRate: '30%',
          threshold: '500元',
          faceValue: '150元',
          dailyAmount: '45,600',
          dailyGMV: '228,000',
          activityFeeRatio: '20.0%',
          mtdAmount: '684,000',
          mtdGMV: '3,420,000',
          mtdFeeRatio: '20.0%'
        },
        {
          planName: `${platformName}生鲜专区`,
          activityType: '品类',
          mechanismType: '品类券',
          mechanism: '满80减15',
          discountRate: '18.8%',
          threshold: '80元',
          faceValue: '15元',
          dailyAmount: '15,750',
          dailyGMV: '84,000',
          activityFeeRatio: '18.8%',
          mtdAmount: '236,250',
          mtdGMV: '1,260,000',
          mtdFeeRatio: '18.8%'
        }
      ];
      
      // 活动方案数据（第二个表格）
      const activityPlan = [
        {
          activityType: '拉新',
          planName: `${platformName}新用户礼包`,
          activityName: '新人专享大礼包',
          mechanismName: '新人券包',
          mechanismType: '券包',
          couponStrength: '满200减80',
          threshold: '200元',
          faceValue: '80元',
          activityTime: '2024-08-01 至 2024-08-31',
          budgetAmount: '500,000',
          mtdAmount: '342,150',
          mtdProgress: '68.4%',
          timeProgress: '80.6%',
          remainingBudget: '157,850'
        },
        {
          activityType: '促销',
          planName: `${platformName}周末狂欢`,
          activityName: '周末购物节',
          mechanismName: '周末券',
          mechanismType: '时段券',
          couponStrength: '满150减40',
          threshold: '150元',
          faceValue: '40元',
          activityTime: '2024-08-03 至 2024-08-31',
          budgetAmount: '300,000',
          mtdAmount: '185,600',
          mtdProgress: '61.9%',
          timeProgress: '75.9%',
          remainingBudget: '114,400'
        },
        {
          activityType: '会员',
          planName: `${platformName}VIP特权`,
          activityName: 'VIP会员专享日',
          mechanismName: 'VIP专享券',
          mechanismType: '会员券',
          couponStrength: '满100减35',
          threshold: '100元',
          faceValue: '35元',
          activityTime: '2024-08-01 至 2024-08-31',
          budgetAmount: '200,000',
          mtdAmount: '124,800',
          mtdProgress: '62.4%',
          timeProgress: '80.6%',
          remainingBudget: '75,200'
        },
        {
          activityType: '季节性',
          planName: `${platformName}夏日清凉`,
          activityName: '夏日消暑特惠',
          mechanismName: '夏日券',
          mechanismType: '季节券',
          couponStrength: '满250减70',
          threshold: '250元',
          faceValue: '70元',
          activityTime: '2024-08-01 至 2024-08-31',
          budgetAmount: '600,000',
          mtdAmount: '456,300',
          mtdProgress: '76.1%',
          timeProgress: '80.6%',
          remainingBudget: '143,700'
        },
        {
          activityType: '限时',
          planName: `${platformName}闪购狂欢`,
          activityName: '限时闪购活动',
          mechanismName: '闪购券',
          mechanismType: '限时券',
          couponStrength: '满400减120',
          threshold: '400元',
          faceValue: '120元',
          activityTime: '2024-08-15 至 2024-08-31',
          budgetAmount: '800,000',
          mtdAmount: '298,400',
          mtdProgress: '37.3%',
          timeProgress: '45.2%',
          remainingBudget: '501,600'
        },
        {
          activityType: '品类',
          planName: `${platformName}生鲜特卖`,
          activityName: '生鲜品类促销',
          mechanismName: '生鲜券',
          mechanismType: '品类券',
          couponStrength: '满120减25',
          threshold: '120元',
          faceValue: '25元',
          activityTime: '2024-08-01 至 2024-08-31',
          budgetAmount: '350,000',
          mtdAmount: '231,700',
          mtdProgress: '66.2%',
          timeProgress: '80.6%',
          remainingBudget: '118,300'
        }
      ];
      
      return {
        activityEffect,
        activityPlan
      };
    }
    
    // 填充活动效果数据表（第一个表格）
    function populateActivityEffectTable(data) {
      const tableBody = document.getElementById('activityEffectTableBody');
      if (!tableBody) {
        console.error('找不到activityEffectTableBody元素');
        return;
      }
      
      tableBody.innerHTML = '';
      
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        row.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.planName}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.activityType}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.mechanismType}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.mechanism}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.discountRate}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.threshold}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.faceValue}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.dailyAmount}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.dailyGMV}</td>
          <td class="px-4 py-3 text-sm font-medium ${parseFloat(item.activityFeeRatio) > 18 ? 'text-red-600' : 'text-green-600'}">${item.activityFeeRatio}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.mtdAmount}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.mtdGMV}</td>
          <td class="px-4 py-3 text-sm font-medium ${parseFloat(item.mtdFeeRatio) > 18 ? 'text-red-600' : 'text-green-600'}">${item.mtdFeeRatio}</td>
        `;
        
        tableBody.appendChild(row);
      });
      
      console.log(`活动效果数据表已填充 ${data.length} 条记录`);
    }
    
    // 填充活动方案数据表（第二个表格）
    function populateActivityPlanTable(data) {
      const tableBody = document.getElementById('activityPlanTableBody');
      if (!tableBody) {
        console.error('找不到activityPlanTableBody元素');
        return;
      }
      
      tableBody.innerHTML = '';
      
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        const progressValue = parseFloat(item.mtdProgress);
        const timeProgressValue = parseFloat(item.timeProgress);
        
        // 判断进度状态颜色
        let progressColor = 'text-green-600';
        if (progressValue > timeProgressValue + 10) {
          progressColor = 'text-red-600'; // 超支风险
        } else if (progressValue < timeProgressValue - 10) {
          progressColor = 'text-orange-600'; // 消耗不足
        }
        
        row.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-600">${item.activityType}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.planName}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.activityName}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.mechanismName}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.mechanismType}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.couponStrength}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.threshold}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.faceValue}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.activityTime}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.budgetAmount}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.mtdAmount}</td>
          <td class="px-4 py-3 text-sm font-medium ${progressColor}">${item.mtdProgress}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${item.timeProgress}</td>
          <td class="px-4 py-3 text-sm text-gray-900 font-medium">${item.remainingBudget}</td>
        `;
        
        tableBody.appendChild(row);
      });
      
      console.log(`活动方案数据表已填充 ${data.length} 条记录`);
    }
</script>

<script>
    // 状态更新函数
    function updateStatus(message, icon) {
      const statusText = document.getElementById('statusText');
      const statusIcon = document.getElementById('statusIcon');
      
      if (statusText) {
        statusText.textContent = message;
      }
      if (statusIcon) {
        statusIcon.textContent = icon;
      }
      
      console.log('状态更新:', icon, message);
    }
</script>

</body>
</html>
         
</script>

</body>
</html>
